"use strict";(function(root,factory){root.balanceText=factory()})(this,function(){function noop(){return}function forEach(elements,callback){Array.prototype.forEach.call(elements,callback)}function ready(fn){if(document.readyState!=="loading"){fn()}else if(document.addEventListener){document.addEventListener("DOMContentLoaded",fn)}else{document.attachEvent("onreadystatechange",function(){if(document.readyState!=="loading"){fn()}})}}function debounce(func,threshold,execAsap){var timeout;return function debounced(){var obj=this,args=arguments;function delayed(){if(!execAsap){func.apply(obj,args)}timeout=null}if(timeout){clearTimeout(timeout)}else if(execAsap){func.apply(obj,args)}timeout=setTimeout(delayed,threshold||100)}}function hasTextWrap(){var style=document.documentElement.style;return style.textWrap||style.WebkitTextWrap||style.MozTextWrap||style.MsTextWrap}var breakMatches;function NextWS_params(){this.reset()}NextWS_params.prototype.reset=function(){this.index=0;this.width=0};var isBreakChar=function(txt,index){var re=/(\s|-|\u2014|\u2013|\u00ad)(?![^<]*>)/g,match;if(!breakMatches){breakMatches=[];match=re.exec(txt);while(match!==null){breakMatches.push(match.index);match=re.exec(txt)}}return breakMatches.indexOf(index)!==-1};var removeTags=function(el){var brs=el.querySelectorAll('br[data-owner="balance-text-soft"]');forEach(brs,function(br){br.outerHTML=""});brs=el.querySelectorAll('br[data-owner="balance-text"]');forEach(brs,function(br){br.outerHTML=" "});var spans=el.querySelectorAll('span[data-owner="balance-text-soft"]');if(spans.length>0){forEach(spans,function(span){var textNode=document.createTextNode("Â­");span.parentNode.insertBefore(textNode,span);span.parentNode.removeChild(span)})}spans=el.querySelectorAll('span[data-owner="balance-text-justify"]');if(spans.length>0){var txt="";forEach(spans,function(span){txt+=span.textContent;span.parentNode.removeChild(span)});el.innerHTML=txt}};var isJustified=function(el){var style=el.currentStyle||window.getComputedStyle(el,null);return style.textAlign==="justify"};var justify=function(el,txt,conWidth){txt=txt.trim();var words=txt.split(" ").length;txt=txt+" ";if(words<2){return txt}var tmp=document.createElement("span");tmp.innerHTML=txt;el.appendChild(tmp);var size=tmp.offsetWidth;tmp.parentNode.removeChild(tmp);var wordSpacing=Math.floor((conWidth-size)/(words-1));tmp.style.wordSpacing=wordSpacing+"px";tmp.setAttribute("data-owner","balance-text-justify");var div=document.createElement("div");div.appendChild(tmp);return div.innerHTML};var isBreakOpportunity=function(txt,index){return index===0||index===txt.length||isBreakChar(txt,index-1)&&!isBreakChar(txt,index)};var findBreakOpportunity=function(el,txt,conWidth,desWidth,dir,c,ret){var w;if(txt&&typeof txt==="string"){for(;;){while(!isBreakOpportunity(txt,c)){c+=dir}el.innerHTML=txt.substr(0,c);w=el.offsetWidth;if(dir<0){if(w<=desWidth||w<=0||c===0){break}}else{if(desWidth<=w||conWidth<=w||c===txt.length){break}}c+=dir}}ret.index=c;ret.width=w};var getSpaceWidth=function(el,h){var container=document.createElement("div");container.style.display="block";container.style.position="absolute";container.style.bottom=0;container.style.right=0;container.style.width=0;container.style.height=0;container.style.margin=0;container.style.padding=0;container.style.visibility="hidden";container.style.overflow="hidden";var space=document.createElement("span");space.style.fontSize="2000px";space.innerHTML="&nbsp;";container.appendChild(space);el.appendChild(container);var dims=space.getBoundingClientRect();container.parentNode.removeChild(container);var spaceRatio=dims.height/dims.width;return h/spaceRatio};var watching={sel:[],el:[]};function getElementsList(elements){if(!elements){return[]}if(typeof elements==="string"){return document.querySelectorAll(elements)}if(elements.tagName&&elements.querySelectorAll){return[elements]}return elements}function balanceText(elements){forEach(getElementsList(elements),function(el){var maxTextWidth=5e3;removeTags(el);var oldWS=el.style.whiteSpace;var oldFloat=el.style.float;var oldDisplay=el.style.display;var oldPosition=el.style.position;var oldLH=el.style.lineHeight;el.style.lineHeight="1";var containerWidth=el.offsetWidth;var containerHeight=el.offsetHeight;el.style.whiteSpace="nowrap";el.style.float="none";el.style.display="inline";el.style.position="static";var nowrapWidth=el.offsetWidth;var nowrapHeight=el.offsetHeight;var spaceWidth=oldWS==="pre-wrap"?0:getSpaceWidth(el,nowrapHeight);if(containerWidth>0&&nowrapWidth>containerWidth&&nowrapWidth<maxTextWidth){var remainingText=el.innerHTML;var newText="";var lineText="";var shouldJustify=isJustified(el);var totLines=Math.round(containerHeight/nowrapHeight);var remLines=totLines;var desiredWidth,guessIndex,le,ge,splitIndex,isSoftHyphen;while(remLines>1){breakMatches=null;desiredWidth=Math.round((nowrapWidth+spaceWidth)/remLines-spaceWidth);guessIndex=Math.round((remainingText.length+1)/remLines)-1;le=new NextWS_params;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,-1,guessIndex,le);ge=new NextWS_params;guessIndex=le.index;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,+1,guessIndex,ge);le.reset();guessIndex=ge.index;findBreakOpportunity(el,remainingText,containerWidth,desiredWidth,-1,guessIndex,le);if(le.index===0){splitIndex=ge.index}else if(containerWidth<ge.width||le.index===ge.index){splitIndex=le.index}else{splitIndex=Math.abs(desiredWidth-le.width)<Math.abs(ge.width-desiredWidth)?le.index:ge.index}lineText=remainingText.substr(0,splitIndex).replace(/\s$/,"");isSoftHyphen=Boolean(lineText.match(/\u00ad$/));if(isSoftHyphen){lineText=lineText.replace(/\u00ad$/,'<span data-owner="balance-text-soft">-</span>')}if(shouldJustify){newText+=justify(el,lineText,containerWidth)}else{newText+=lineText;newText+=isSoftHyphen?'<br data-owner="balance-text-soft" />':'<br data-owner="balance-text" />'}remainingText=remainingText.substr(splitIndex);remLines--;el.innerHTML=remainingText;nowrapWidth=el.offsetWidth}if(shouldJustify){el.innerHTML=newText+justify(el,remainingText,containerWidth)}else{el.innerHTML=newText+remainingText}}el.style.whiteSpace=oldWS;el.style.float=oldFloat;el.style.display=oldDisplay;el.style.position=oldPosition;el.style.lineHeight=oldLH})}function updateWatched(){var selectors=watching.sel.join(",");var selectedElements=getElementsList(selectors);var elements=Array.prototype.concat.apply(watching.el,selectedElements);balanceText(elements)}var handlersInitialized=false;function initHandlers(){if(handlersInitialized){return}ready(updateWatched);window.addEventListener("load",updateWatched);window.addEventListener("resize",debounce(updateWatched));handlersInitialized=true}function balanceTextAndWatch(elements){if(typeof elements==="string"){watching.sel.push(elements)}else{forEach(getElementsList(elements),function(el){watching.el.push(el)})}initHandlers();updateWatched()}var polyfilled=false;function polyfill(){if(polyfilled){return}watching.sel.push(".balance-text");initHandlers();polyfilled=true}function publicInterface(elements,options){if(!elements){polyfill()}else if(options&&options.watch){balanceTextAndWatch(elements)}else{balanceText(elements)}}publicInterface.updateWatched=updateWatched;if(hasTextWrap()){noop.updateWatched=noop;return noop}return publicInterface});(balanceText())
